{"version":3,"file":"mobx-hooks-form.cjs.production.min.js","sources":["../src/index.tsx"],"sourcesContent":["import React, { useContext } from 'react'\nimport { autorun, computed, action, observable } from 'mobx'\nimport { useLocalStore, observer } from 'mobx-react-lite'\nimport { isEmpty } from 'lodash'\nimport { pick } from 'lodash/fp'\nimport * as yup from 'yup'\n\nfunction getErrorsFromValidationError(validationError: yup.ValidationError): Errors {\n\tconst FIRST_ERROR = 0\n\treturn validationError.inner.reduce((errors, error) => {\n\t\treturn {\n\t\t\t...errors,\n\t\t\t[error.path]: error.errors[FIRST_ERROR],\n\t\t}\n\t}, {})\n}\n\nfunction validate(schema: yup.ObjectSchema<Values>, values: {}) {\n\ttry {\n\t\tschema.validateSync(values, { abortEarly: false, recursive: true })\n\t\treturn {}\n\t} catch (error) {\n\t\treturn getErrorsFromValidationError(error)\n\t}\n}\n\ninterface Values {\n\t[index: string]: yup.Schema<any>\n}\ninterface Touched {\n\t[index: string]: boolean\n}\ninterface Errors {\n\t[index: string]: string\n}\n\ninterface UseForm {\n\tscheme: yup.ObjectSchema<Values>\n\tinitialValues: Values\n\tname: string\n}\n\nclass Store {\n\tconstructor(props: UseForm) {\n\t\tconst { scheme, initialValues, name = '' } = props\n\t\tthis.scheme = scheme\n\t\tthis.formName = name\n\t\tthis.keys = Object.keys(initialValues)\n\t\tthis.values = initialValues || {}\n\n\t\tautorun(() => {\n\t\t\tthis.keys.forEach(key => {\n\t\t\t\tconst validation = this.validations[key]\n\t\t\t\tconst touched = this.touched[key]\n\t\t\t\tif (!validation) {\n\t\t\t\t\tdelete this.errors[key]\n\t\t\t\t} else if (touched) {\n\t\t\t\t\tthis.errors[key] = validation\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\n\tformName: string\n\tscheme: yup.ObjectSchema<Values>\n\tkeys: string[]\n\n\t@observable values: Values\n\t@observable touched = {} as Touched\n\t@observable errors = {} as Errors\n\n\t@computed get validations() {\n\t\treturn validate(this.scheme, this.values)\n\t}\n\t@computed get isValid() {\n\t\treturn isEmpty(this.validations)\n\t}\n\n\t@action setValue = (key: string) => (value: any) => {\n\t\tthis.values[key] = value\n\t}\n\n\t@action touch = (key: string) => (this.touched[key] = true)\n\t@action touchAll = () =>\n\t\tthis.keys.forEach(key => {\n\t\t\tthis.touched[key] = true\n\t\t})\n\n\t@action updateValues = (values: Values) =>\n\t\tObject.assign(this.values, pick(this.keys)(values))\n\n\t@action handleChange = (key: string) => (e: React.ChangeEvent<HTMLInputElement>) => {\n\t\tthis.setValue(key)(e.target.value)\n\t}\n\t@action handleCheckedChange = (key: string) => (\n\t\te: React.ChangeEvent<HTMLInputElement>\n\t) => {\n\t\tthis.setValue(key)(e.target.checked)\n\t}\n\t@action handleBlur = (key: string) => () => {\n\t\tthis.touch(key)\n\t}\n\n\tgetValue = (key: string) => this.values[key]\n\tgetError = (key: string) => this.errors[key]\n\tisRequired = (name: string) => (this.scheme.fields[name] as any)._exclusive.required\n\n\t@action handleSubmit = (submit: () => void) => (\n\t\te: React.ChangeEvent<HTMLInputElement>\n\t) => {\n\t\te.preventDefault()\n\t\tthis.touchAll()\n\t\tif (this.isValid) {\n\t\t\tsubmit()\n\t\t}\n\t}\n}\n\nexport const useForm = (props: UseForm) =>\n\tuseLocalStore(source => new Store(source), props)\n\nconst FormContext = React.createContext({} as ReturnType<typeof useForm>)\nexport const useFormContext = () => useContext(FormContext)\nexport const FormContextProvider = ({\n\tchildren,\n\tformStore,\n}: {\n\tchildren: React.ReactChildren\n\tformStore: ReturnType<typeof useForm>\n}) => <FormContext.Provider value={formStore}>{children}</FormContext.Provider>\n\nconst FieldContext = React.createContext({})\nexport const useFieldContext = () => useContext(FieldContext)\nexport const FieldContextProvider = observer(\n\t({\n\t\tchildren,\n\t\tname,\n\t}: {\n\t\tchildren: (arg0: any) => React.ReactNode | React.ReactChildren\n\t\tname: string\n\t}) => {\n\t\tconst store = useContext(FormContext)\n\n\t\tconst fieldContext = {\n\t\t\tname,\n\t\t\tid: `${store.formName}_${name}`,\n\t\t\tsetValue: store.setValue(name),\n\t\t\terror: store.getError(name),\n\t\t\tvalue: store.getValue(name),\n\t\t\tonBlur: store.handleBlur(name),\n\t\t\tonChange: store.handleChange(name),\n\t\t\tonCheckedChange: store.handleCheckedChange(name),\n\t\t\tisRequired: store.isRequired(name),\n\t\t}\n\n\t\treturn (\n\t\t\t<FieldContext.Provider value={fieldContext}>\n\t\t\t\t{typeof children === 'function' ? children(fieldContext) : children}\n\t\t\t</FieldContext.Provider>\n\t\t)\n\t}\n)\n\n// Object.keys(state.errors).forEach(key => {\n// if (!has(key)(state.validations)) {\n// delete state.errors[key]\n// }\n// })\n// @action validationsToErrors() {\n//     Object.keys(state.errors).forEach(key => {\n//         if (!has(key)(state.validations)) {\n//             delete state.errors[key]\n//         }\n//     })\n//     Object.entries(state.validations).forEach(([key, value]) => {\n//         if (state.touched[key]) {\n//             state.errors[key] = value\n//         }\n//     })\n// }\n// state.validationsToErrors()\n// autorun(() => {\n//     state.validationsToErrors()\n// })\n// @observable errors = {} as Errors\n// @computed get errors() {\n// \tconst errors = {} as Errors\n// \tObject.entries(this.validations).forEach(([key, value]) => {\n// \t\tif (this.touched[key]) {\n// \t\t\terrors[key] = value\n// \t\t}\n// \t})\n// \treturn errors\n// }\n// export function useForm(props: UseForm) {\n// \tconst state = useLocalStore(source => new Store(source), props)\n\n// \treturn {\n// \t\tgetValue: state.getValue,\n// \t\tgetError: state.getError,\n// \t\tupdateValues: state.updateValues,\n// \t\tsetValue: state.setValue,\n// \t\tgetValues: state.getValues,\n// \t\tisValid: () => state.isValid,\n// \t\thandleChange: state.handleChange,\n// \t\thandleCheckedChange: state.handleCheckedChange,\n// \t\thandleBlur: state.handleBlur,\n// \t\tformName: state.formName,\n// \t\tgetFieldProps: state.getFieldProps,\n// \t\thandleSubmit: state.handleSubmit,\n// \t\tisRequired: state.isRequired,\n// \t}\n// }\n"],"names":["Store","props","key","value","_this","values","touched","keys","forEach","Object","assign","pick","e","setValue","target","checked","touch","errors","name","scheme","fields","_exclusive","required","submit","preventDefault","touchAll","isValid","initialValues","formName","autorun","validation","validations","schema","validateSync","abortEarly","recursive","error","inner","reduce","path","validate","this","isEmpty","__decorate","observable","computed","action","FormContext","React","createContext","FieldContext","observer","children","store","useContext","fieldContext","id","getError","getValue","onBlur","handleBlur","onChange","handleChange","onCheckedChange","handleCheckedChange","isRequired","Provider","formStore","useLocalStore","source"],"mappings":"odA0CMA,wBACOC,2BAyBU,eACD,iBASF,SAACC,UAAgB,SAACC,GACpCC,EAAKC,OAAOH,GAAOC,eAGJ,SAACD,UAAiBE,EAAKE,QAAQJ,IAAO,iBACnC,kBAClBE,EAAKG,KAAKC,SAAQ,SAAAN,GACjBE,EAAKE,QAAQJ,IAAO,wBAGC,SAACG,UACvBI,OAAOC,OAAON,EAAKC,OAAQM,OAAKP,EAAKG,KAAVI,CAAgBN,uBAErB,SAACH,UAAgB,SAACU,GACxCR,EAAKS,SAASX,EAAdE,CAAmBQ,EAAEE,OAAOX,kCAEC,SAACD,UAAgB,SAC9CU,GAEAR,EAAKS,SAASX,EAAdE,CAAmBQ,EAAEE,OAAOC,2BAER,SAACb,UAAgB,WACrCE,EAAKY,MAAMd,mBAGD,SAACA,UAAgBE,EAAKC,OAAOH,kBAC7B,SAACA,UAAgBE,EAAKa,OAAOf,oBAC3B,SAACgB,UAAkBd,EAAKe,OAAOC,OAAOF,GAAcG,WAAWC,4BAErD,SAACC,UAAuB,SAC9CX,GAEAA,EAAEY,iBACFpB,EAAKqB,WACDrB,EAAKsB,SACRH,UArEeI,EAA6B1B,EAA7B0B,gBAA6B1B,EAAdiB,KAAAA,aAAO,UACjCC,OADwClB,EAArCkB,YAEHS,SAAWV,OACXX,KAAOE,OAAOF,KAAKoB,QACnBtB,OAASsB,GAAiB,GAE/BE,WAAQ,WACPzB,EAAKG,KAAKC,SAAQ,SAAAN,OACX4B,EAAa1B,EAAK2B,YAAY7B,GAE/B4B,EADW1B,EAAKE,QAAQJ,KAI5BE,EAAKa,OAAOf,GAAO4B,UAFZ1B,EAAKa,OAAOf,kEAtCxB,SAAkB8B,EAAkC3B,cAElD2B,EAAOC,aAAa5B,EAAQ,CAAE6B,YAAY,EAAOC,WAAW,IACrD,GACN,MAAOC,UAC4BA,EAbdC,MAAMC,QAAO,SAACrB,EAAQmB,qBAExCnB,UACFmB,EAAMG,MAAOH,EAAMnB,OAJF,SAMjB,KA0DKuB,CAASC,KAAKtB,OAAQsB,KAAKpC,+CAG3BqC,UAAQD,KAAKV,2MARTY,cAAXC,2CACWD,cAAXC,4CACWD,cAAXC,2CAESD,cAATE,4CAGSF,cAATE,wCAIOF,cAAPG,yCAIOH,cAAPG,sCACOH,cAAPG,yCAKOH,cAAPG,6CAGOH,cAAPG,6CAGOH,cAAPG,oDAKOH,cAAPG,2CAQOH,cAAPG,iDAcIC,EAAcC,EAAMC,cAAc,IAUlCC,EAAeF,EAAMC,cAAc,iCAELE,YACnC,gBACCC,IAAAA,SACAlC,IAAAA,KAKMmC,EAAQC,aAAWP,GAEnBQ,EAAe,CACpBrC,KAAAA,EACAsC,GAAOH,EAAMzB,aAAYV,EACzBL,SAAUwC,EAAMxC,SAASK,GACzBkB,MAAOiB,EAAMI,SAASvC,GACtBf,MAAOkD,EAAMK,SAASxC,GACtByC,OAAQN,EAAMO,WAAW1C,GACzB2C,SAAUR,EAAMS,aAAa5C,GAC7B6C,gBAAiBV,EAAMW,oBAAoB9C,GAC3C+C,WAAYZ,EAAMY,WAAW/C,WAI7B8B,gBAACE,EAAagB,UAAS/D,MAAOoD,GACR,mBAAbH,EAA0BA,EAASG,GAAgBH,kCAlC5B,mBAM7BJ,gBAACD,EAAYmB,UAAS/D,QAJ3BgE,aADAf,mCAQ8B,kBAAME,aAAWJ,oBAdzB,SAACjD,UACvBmE,iBAAc,SAAAC,UAAU,IAAIrE,EAAMqE,KAASpE,2BAGd,kBAAMqD,aAAWP"}